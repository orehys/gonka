{% extends "base.html" %}
{% block content %}
{% load money static %}
<style>

.js-final-selectify{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  width:100%;
  padding:10px 42px 10px 12px;
  border-radius:12px; border:1px solid #E6E6E6;
  background:#F8F8F8; color:#1A1A1A;
  font:400 14px/18px Roboto, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
  background-image:none; box-shadow:none;
}
.js-final-selectify:hover:not(:disabled){ border-color:#DCDCDC; background:#F4F4F4; }
.js-final-selectify:focus{ outline:0; border-color:#4339DA; box-shadow:0 0 0 4px rgba(67,57,218,.12); background:#fff; }
.js-final-selectify:disabled{ background:#F6F6F6; color:#9B9B9B; border-color:#EEE; }
.js-final-selectify::-ms-expand{ display:none; }


.final-selectify{ position:relative; width:100%;margin-top: 12px;  }
.final-selectify.is-disabled{ opacity:.6; pointer-events:none; }

.final-selectify__btn{
  width:100%; text-align:left; cursor:pointer;
   color:#1A1A1A;
  border: 2px solid #E8E8EA; border-radius:12px; outline:none;
  background-color: white;  
  padding:12px; height: 48px;
  font:400 14px/18px Roboto, system-ui, -apple-system, "Segoe UI", Arial, sans-serif; color: #1C1C1C;
}
.final-selectify__btn::after{
  content:"";
  position:absolute;
  top:50%; right:12px;
  transform: translateY(-50%) rotate(180deg);
  width:20px; height:20px;
  background: url("/static/img/strel_sum.svg") center / contain no-repeat;
  pointer-events:none;
  opacity:.7;
  transition: transform .2s ease, opacity .2s ease;
}

.final-selectify.is-open .final-selectify__btn::after{
  transform: translateY(-50%) rotate(0deg);
  opacity:1;
}


.final-selectify.is-disabled .final-selectify__btn::after{
  opacity:.35;
}
.final-selectify__btn:focus{ border-color:#4339DA; box-shadow:0 0 0 4px rgba(67,57,218,.12); background:#fff; }

.final-selectify__list{
  position:absolute; z-index:50; left:0; right:0; top:calc(100% + 6px);
  background:#fff; color:#111;
  border:1px solid #E6E6E6; border-radius:12px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
  max-height:280px; overflow:auto; padding:6px; display:none;
}
.final-selectify.is-open .final-selectify__list{ display:block; }

.final-selectify__opt{
  padding:10px 12px; border-radius:10px; cursor:pointer; user-select:none;
}
.final-selectify__opt:hover,
.final-selectify__opt[aria-selected="true"]{ background:#F4F4F4; }
.final-selectify__opt.is-current{ outline:2px solid rgba(67,57,218,.25); }

.final-selectify__placeholder{ color:#9B9B9B; }

</style>
<section class="catalog_page">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="breadcrumbs">
                    <a href="/">Главная</a> / <a href="{% url 'page_avtoservis_short' %}">Автосервис</a> / <a href="{% url 'page_chip_tuning_short' %}">Чиптюнинг</a>
                </div>
            </div>
            <div class="col-lg-3 d-lg-block d-none">

            </div>
            <div class="col-lg-9">
                <section class="finder mt-0">
                    <div class="container">
                        
                        <form method="get" class="row">
                            <div class="col-md-3 col-6">
                                <select name="make"   class="mt-0 js-final-selectify" onchange="this.form.submit()">
                                <option disabled {% if not make %}selected{% endif %}>Марка</option>
                                {% for v in make_options %}<option value="{{ v }}" {% if v == make %}selected{% endif %}>{{ v }}</option>{% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3 col-6">
                                <select name="model"  class="mt-0 js-final-selectify" onchange="this.form.submit()">
                                <option disabled {% if not model %}selected{% endif %}>Модель</option>
                                {% for v in model_options %}<option value="{{ v }}" {% if v == model %}selected{% endif %}>{{ v }}</option>{% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3 col-6">
                                <select name="year"   class="mt-0 js-final-selectify" onchange="this.form.submit()">
                                <option disabled {% if not year %}selected{% endif %}>Год выпуска</option>
                                {% for v in year_options %}<option value="{{ v }}" {% if v == year %}selected{% endif %}>{{ v }}</option>{% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3 col-6">
                                <select name="engine" class="mt-0 js-final-selectify" onchange="this.form.submit()">
                                <option disabled {% if not engine %}selected{% endif %}>Мотор</option>
                                {% for v in engine_options %}<option value="{{ v }}" {% if v == engine %}selected{% endif %}>{{ v }}</option>{% endfor %}
                                </select>
                            </div>
                            </form>

                    </div>
                    </section>

                    <div class="comparison-container">

                    <div class="center d-flex justify-content-center">
                        <div class="tabs {% if not stages %}d-none{% endif %} mb-0">
                          {% for s in stages %}
                            <a href="?make={{ make }}&model={{ model }}&year={{ year }}&engine={{ engine }}&stage={{ s.id }}">
                              <button class="tab {% if current_stage and s.id == current_stage.id %}active{% endif %}">
                                {{ s.name }}
                              </button>
                            </a>
                          {% endfor %}
                        </div>
                    </div>
                    <div class="comparison-table-wrapper" style="margin-top: 24px;">
                        <table class="comparison-table">
                        <thead>
                            <tr>
                            <th>Параметр</th>
                            <th>Заводские</th>
                            <th>После тюнинга*</th>
                            <th>Разница</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if metrics %}
                            {% for m in metrics %}
                                <tr>
                                <td>{{ m.label }}</td>
                                <td>{{ m.stock }}</td>
                                <td>{{ m.tuned }}</td>
                                <td>{{ m.delta }}</td>
                                </tr>
                            {% endfor %}
                            {% elif make or model or year or engine %}
                            <tr><td colspan="4" class="text-muted">Для выбранной конфигурации данных пока нет.</td></tr>
                            {% else %}
                            <tr><td colspan="4" class="text-muted">Выберите марку, модель, год и мотор.</td></tr>
                            {% endif %}
                        </tbody>
                        </table>
                    </div>
                    </div>
                    <div class="">
                        <div class="dropdown d-none ">
                            <button type="button" class="dropdown-button">
                                Дополнительные опции
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="19" viewBox="0 0 18 19" fill="none">
                                    <path d="M12 8.35938L9 11.3594L6 8.35938" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  </svg>
                            </button>
                        </div>
                        <div class="price-section" style="margin-top: 24px;">
                            
                            <div class="price-info">
                            {% if current_stage and current_stage.price %}
                                <p>Стоимость:
                                    <span class="price">{{ current_stage.price|money }}</span>
                                    <span class="old-price">{{ current_stage.old_price|money }}</span>
                                </p>
                                {% else %}
                                <p>Стоимость: по&nbsp;запросу</p>
                                {% endif %}

                            </div>
                            <div class="cta-button">
                                <button type="button" class="button d-none">Заказать тюнинг</button>
                            </div>
                        </div>
                        <p class="note">
                            * Для достижения вышеуказанных цифр, требуется использование качественного топлива с октановым числом не ниже 98, <br class="d-xl-block d-none"> рекомендуется 100, при использовании 95 бензина, показатели будут отличаться.
                        </p>

                        {% if car and siblings_rows %}
                        <div class="mt-0">
                        <h2 class="bmw-table-title">
                            Чип-тюнинг других модификаций {{ car.make }} {{ base_model }}
                        </h2>
                        <div class="bmw-table-wrapper">
                            <table class="bmw-comparison-table">
                            <thead>
                                <tr>
                                <th>Модификация</th>
                                <th>Объем двигателя</th>
                                <th>Мощность</th>
                                <th>Крутящий момент</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in siblings_rows %}
                                <tr onclick="location.href='{{ r.url }}'" style="cursor:pointer">
                                <td>{{ r.title }}</td>
                                <td>{{ r.engine_volume }}</td>
                                <td>{{ r.power }}</td>
                                <td>{{ r.torque }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            </table>
                        </div>
                        </div>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
(function(){
  var isTouch = window.matchMedia("(pointer: coarse)").matches;

  document.querySelectorAll("select.js-final-selectify").forEach(function(sel){
    if (isTouch) return; 

    var wrap = document.createElement("div");
    wrap.className = "final-selectify" + (sel.disabled ? " is-disabled" : "");
    sel.parentNode.insertBefore(wrap, sel);
    wrap.appendChild(sel);
    sel.style.display = "none";

    var btn = document.createElement("button");
    btn.type = "button";
    btn.className = "final-selectify__btn";
    btn.setAttribute("aria-haspopup","listbox");
    btn.setAttribute("aria-expanded","false");
    wrap.appendChild(btn);

    var list = document.createElement("div");
    list.className = "final-selectify__list";
    list.setAttribute("role","listbox");
    wrap.appendChild(list);

    function label(){
      var cur = sel.options[sel.selectedIndex];
      if (cur && !cur.disabled) return cur.textContent.trim();
      var ph = sel.querySelector("option[disabled]") || sel.options[0];
      return ph ? ph.textContent.trim() : "Выбрать";
    }
    function renderBtn(){
      var isPh = (sel.options[sel.selectedIndex]?.disabled) || sel.selectedIndex < 0;
      btn.innerHTML = '<span class="'+(isPh?'final-selectify__placeholder':'')+'">'+ label() +'</span>';
    }
    function renderList(){
      list.innerHTML = "";
      Array.from(sel.options).forEach(function(opt){
        if (opt.disabled) return; 
        var it = document.createElement("div");
        it.className = "final-selectify__opt";
        it.setAttribute("role","option");
        it.setAttribute("data-value", opt.value);
        if (opt.selected) it.setAttribute("aria-selected","true");
        it.textContent = opt.textContent;
        it.addEventListener("click", function(){
          if (sel.value !== opt.value){
            sel.value = opt.value;
            sel.dispatchEvent(new Event("change", {bubbles:true}));
          }
          close();
        });
        list.appendChild(it);
      });
    }

    function open(){
      wrap.classList.add("is-open");
      btn.setAttribute("aria-expanded","true");
      document.addEventListener("click", onDoc, {capture:true, once:true});
      document.addEventListener("keydown", onKey);
      highlightCurrent();
    }
    function close(){
      wrap.classList.remove("is-open");
      btn.setAttribute("aria-expanded","false");
      document.removeEventListener("keydown", onKey);
    }
    function onDoc(e){
      if (!wrap.contains(e.target)) close();
      else document.addEventListener("click", onDoc, {capture:true, once:true});
    }

    function highlightCurrent(move){
      var items = Array.from(list.querySelectorAll(".final-selectify__opt"));
      var idx = Math.max(0, items.findIndex(n => n.getAttribute("aria-selected")==="true"));
      if (move === "down") idx = Math.min(idx+1, items.length-1);
      if (move === "up")   idx = Math.max(idx-1, 0);
      items.forEach(n => n.classList.remove("is-current"));
      var cur = items[idx]; if (cur){ cur.classList.add("is-current"); cur.scrollIntoView({block:"nearest"}); }
    }
    function onKey(e){
      if (e.key === "ArrowDown"){ e.preventDefault(); highlightCurrent("down"); }
      else if (e.key === "ArrowUp"){ e.preventDefault(); highlightCurrent("up"); }
      else if (e.key === "Enter"){ e.preventDefault(); var cur=list.querySelector(".final-selectify__opt.is-current"); cur?.click(); }
      else if (e.key === "Escape"){ e.preventDefault(); close(); btn.focus(); }
    }

    btn.addEventListener("click", function(){
      wrap.classList.contains("is-open") ? close() : open();
    });

    sel.addEventListener("change", function(){
      var v = sel.value;
      list.querySelectorAll(".final-selectify__opt").forEach(function(n){
        n.toggleAttribute("aria-selected", n.getAttribute("data-value") === v);
      });
      renderBtn();
    });

    var mo = new MutationObserver(function(muts){
      if (muts.some(m => m.type === "attributes" && m.attributeName === "disabled")){
        wrap.classList.toggle("is-disabled", sel.disabled);
        btn.disabled = sel.disabled;
      }
    });
    mo.observe(sel, {attributes:true, attributeFilter:["disabled"]});

    renderBtn();
    renderList();
  });
})();
</script>

{% endblock %}
