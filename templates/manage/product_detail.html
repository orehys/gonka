{% extends "manage/base_admin.html" %}
{% load money static %}
{% block content %}

<div class="bg-white p-3 rounded shadow-sm">

  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h4 class="mb-1">Редактирование товара</h4>
      <div class="text-muted">ID {{ p.id }} · SKU <code>{{ p.sku }}</code> · {{ brands|join:', ' }}</div>
    </div>
    <div class="text-end">
      <form action="{% url 'catalog:m_product_toggle' p.id %}" method="post" class="d-inline">
        {% csrf_token %}
        <button class="btn btn-sm {% if p.is_active %}btn-outline-warning{% else %}btn-success{% endif %}">
          {% if p.is_active %}Скрыть{% else %}Показать{% endif %}
        </button>
      </form>
      <form action="{% url 'catalog:m_product_delete' p.id %}" method="post" class="d-inline" onsubmit="return confirm('Удалить товар и все его фото?')">
        {% csrf_token %}
        <button class="btn btn-sm btn-danger">Удалить</button>
      </form>
    </div>
  </div>

  <hr>

  <!-- ФОРМА ОСНОВНЫХ ПОЛЕЙ -->
  <form method="post" class="row g-3">
    {% csrf_token %}
    <input type="hidden" name="action" value="save_main">

    <div class="col-md-6">
      <label class="form-label">Название</label>
      <input type="text" name="title" value="{{ p.title }}" class="form-control">
    </div>
    <div class="col-md-6">
      <label class="form-label">SKU (Артикул)</label>
      <input type="text" name="sku" value="{{ p.sku }}" class="form-control">
      <div class="form-text">Должен быть уникальным</div>
    </div>

    <div class="col-12">
      <label class="form-label">Описание</label>
      <textarea name="description" rows="4" class="form-control">{{ p.description }}</textarea>
    </div>

    <div class="col-md-3">
      <label class="form-label">Цена (новая)</label>
      <input type="text" name="price" value="{{ p.price }}" class="form-control">
      <div class="form-text">Текущая цена</div>
    </div>

    <div class="col-md-3">
      <label class="form-label">Старая цена</label>
      <input type="text" name="old_price" value="{{ p.old_price|default_if_none:'' }}" class="form-control">
      <div class="form-text">Пусто = считать 10% от текущей</div>
    </div>

    <div class="col-md-3">
    <label class="form-label">Себестоимость (тех.)</label>
    <input type="text" name="cost_price" value="{{ p.cost_price|default_if_none:'' }}" class="form-control">
    <div class="form-text">Поле видно только в админке, на сайте не отображается</div>
  </div>
  <div class="col-md-3">
  <label class="form-label">Остаток</label>
  <input type="number" name="stock" min="0" value="{{ p.stock }}" class="form-control">
  <div class="form-text">Пусто = не указан</div>
</div>


    <div class="col-md-3">
      <label class="form-label">Категория (родитель)</label>
      <select name="parent_id" class="form-select">
        <option value="">— не менять —</option>
        {% for c in top_cats %}
          <option value="{{ c.id }}" {% if parent and parent.id == c.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Подкатегория</label>
      <select name="sub_id" class="form-select">
        <option value="">— не менять —</option>
        {% for c in subs %}
          <option value="{{ c.id }}" {% if p.category.id == c.id %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12">
      <button class="btn btn-primary">Сохранить</button>
      <a class="btn btn-outline-secondary" target="_blank" href="{% url 'catalog:product_detail' p.slug %}">Открыть на сайте</a>
    </div>
  </form>

  <hr>

  <div class="row">
    <div class="col-lg-7">
      <!-- БЛОК ХАРАКТЕРИСТИКИ -->
      <h6>Характеристики (замена целиком)</h6>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="save_specs">
        <textarea name="specs_text" rows="8" class="form-control" placeholder="Марка авто: Audi&#10;Модель авто: A4, A5">{{ specs_text }}</textarea>
        <div class="form-text">Формат: «Имя: значение1, значение2». Каждая характеристика с новой строки.</div>
        <button class="btn btn-outline-primary mt-2">Перезаписать характеристики</button>
      </form>
    </div>

    <div class="col-lg-5">
      <!-- БЛОК ФОТО -->
      <h6>Фото</h6>
      <div class="row g-2">
        {% for im in p.images.all %}
          <div class="col-4">
            <div class="border rounded p-1">
              <img src="{{ im.image.url }}" class="w-100" style="aspect-ratio:1/1;object-fit:cover">
              <form action="{% url 'catalog:m_product_image_delete' p.id im.id %}" method="post" onsubmit="return confirm('Удалить фото?')">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger w-100 mt-1">Удалить</button>
              </form>
            </div>
          </div>
        {% empty %}
          <div class="col-12 text-muted">Пока нет фото</div>
        {% endfor %}
      </div>

      <form class="mt-3"
      action="{% url 'catalog:m_product_images_add' p.id %}"
      method="post"
      enctype="multipart/form-data">
        {% csrf_token %}
        <!-- имя поля ДОЛЖНО быть "images" -->
        <input type="file" name="images" multiple class="form-control">
        <button class="btn btn-sm btn-primary mt-2">Загрузить</button>
        </form>


    </div>
  </div>
</div>
{% endblock %}
